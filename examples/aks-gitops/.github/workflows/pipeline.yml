name: Pipeline

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]

# Example: .NET API deployed to AKS using an external GitOps config repo
# Helm values are stored in a separate repository (config repo)
# See examples/pipeline-repo/ for the config repo structure

jobs:
  ci:
    uses: nuvtools/nuvtools-templates-azure-cicd/.github/workflows/ci.yml@v1
    with:
      dotnet-version: '10.0.x'
      project-path: 'src/MyApp.API/MyApp.API.csproj'
      test-path: 'tests/MyApp.UnitTests/MyApp.UnitTests.csproj'
      build-docker: true
      acr-registry: myregistry.azurecr.io
      image-name: my-app-api
      entry-point-dll: MyApp.API.dll
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

  # Deploy to dev (automatic on push to main)
  deploy-dev:
    needs: ci
    if: needs.ci.outputs.should-deploy == 'true' && needs.ci.outputs.environment == 'dev'
    uses: nuvtools/nuvtools-templates-azure-cicd/.github/workflows/cd-aks.yml@v1
    with:
      environment: dev
      image-uri: ${{ needs.ci.outputs.image-uri }}
      app-version: ${{ needs.ci.outputs.version }}
      aks-cluster-name: my-aks-dev
      aks-resource-group: rg-dev
      namespace: my-app
      release-name: my-app-api
      # Paths relative to config repo root
      values-file: my-app/values-dev.yaml
      env-values-file: my-app/env-values-dev.yaml
      # GitOps repository with Helm values per environment
      config-repo: myorg/my-pipeline-repo
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      CONFIG_REPO_TOKEN: ${{ secrets.CONFIG_REPO_TOKEN }}

  # Deploy to staging (prerelease tags: v*-alpha*, v*-beta*, v*-rc*)
  deploy-staging:
    needs: ci
    if: needs.ci.outputs.should-deploy == 'true' && needs.ci.outputs.environment == 'staging'
    uses: nuvtools/nuvtools-templates-azure-cicd/.github/workflows/cd-aks.yml@v1
    with:
      environment: staging
      image-uri: ${{ needs.ci.outputs.image-uri }}
      app-version: ${{ needs.ci.outputs.version }}
      aks-cluster-name: my-aks-staging
      aks-resource-group: rg-staging
      namespace: my-app
      release-name: my-app-api
      values-file: my-app/values-staging.yaml
      env-values-file: my-app/env-values-staging.yaml
      config-repo: myorg/my-pipeline-repo
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      CONFIG_REPO_TOKEN: ${{ secrets.CONFIG_REPO_TOKEN }}

  # Deploy to production (release tags: v*)
  deploy-production:
    needs: ci
    if: needs.ci.outputs.should-deploy == 'true' && needs.ci.outputs.environment == 'production'
    uses: nuvtools/nuvtools-templates-azure-cicd/.github/workflows/cd-aks.yml@v1
    with:
      environment: production
      image-uri: ${{ needs.ci.outputs.image-uri }}
      app-version: ${{ needs.ci.outputs.version }}
      aks-cluster-name: my-aks-prod
      aks-resource-group: rg-production
      namespace: my-app
      release-name: my-app-api
      values-file: my-app/values-production.yaml
      env-values-file: my-app/env-values-production.yaml
      config-repo: myorg/my-pipeline-repo
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      CONFIG_REPO_TOKEN: ${{ secrets.CONFIG_REPO_TOKEN }}
