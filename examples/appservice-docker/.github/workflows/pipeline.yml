name: Pipeline

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]

# Example: .NET API deployed to Azure App Service via Docker container
# Uses ACR for image storage and deployment slots in production

jobs:
  ci:
    uses: nuvtools/nuvtools-templates-azure-cicd/.github/workflows/ci.yml@v1
    with:
      dotnet-version: '10.0.x'
      project-path: 'src/MyApp.API/MyApp.API.csproj'
      test-path: 'tests/MyApp.UnitTests/MyApp.UnitTests.csproj'
      build-docker: true
      acr-registry: myregistry.azurecr.io
      image-name: my-app-api
      entry-point-dll: MyApp.API.dll
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

  # Deploy to dev (automatic on push to main)
  deploy-dev:
    needs: ci
    if: needs.ci.outputs.should-deploy == 'true' && needs.ci.outputs.environment == 'dev'
    uses: nuvtools/nuvtools-templates-azure-cicd/.github/workflows/cd-appservice.yml@v1
    with:
      environment: dev
      app-version: ${{ needs.ci.outputs.version }}
      deploy-mode: docker
      app-service-name: my-app-dev
      resource-group: rg-dev
      image-uri: ${{ needs.ci.outputs.image-uri }}
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

  # Deploy to staging (prerelease tags: v*-alpha*, v*-beta*, v*-rc*)
  deploy-staging:
    needs: ci
    if: needs.ci.outputs.should-deploy == 'true' && needs.ci.outputs.environment == 'staging'
    uses: nuvtools/nuvtools-templates-azure-cicd/.github/workflows/cd-appservice.yml@v1
    with:
      environment: staging
      app-version: ${{ needs.ci.outputs.version }}
      deploy-mode: docker
      app-service-name: my-app-staging
      resource-group: rg-staging
      image-uri: ${{ needs.ci.outputs.image-uri }}
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

  # Deploy to production with slot swap (release tags: v*)
  deploy-production:
    needs: ci
    if: needs.ci.outputs.should-deploy == 'true' && needs.ci.outputs.environment == 'production'
    uses: nuvtools/nuvtools-templates-azure-cicd/.github/workflows/cd-appservice.yml@v1
    with:
      environment: production
      app-version: ${{ needs.ci.outputs.version }}
      deploy-mode: docker
      app-service-name: my-app-prod
      resource-group: rg-production
      image-uri: ${{ needs.ci.outputs.image-uri }}
      use-deployment-slot: true
      slot-name: staging
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
