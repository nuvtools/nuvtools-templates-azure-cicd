name: Build & Deploy AKS
run-name: Build & Deploy AKS ðŸš€ ${{ github.ref_name }}

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]

# Full example: .NET API deployed to AKS via Helm
# Uses per-environment Helm values stored in the application repo

jobs:
  ci:
    uses: nuvtools/nuvtools-templates-azure-cicd/.github/workflows/ci.yml@v1
    with:
      dotnet-version: '10.0.x'
      project-path: 'src/MyApp.API/MyApp.API.csproj'
      test-path: 'tests/MyApp.UnitTests/MyApp.UnitTests.csproj'
      build-docker: true
      acr-registry: myregistry.azurecr.io
      image-name: my-app-api
      entry-point-dll: MyApp.API.dll
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

  # Deploy to dev (automatic on push to main)
  deploy-dev:
    needs: ci
    if: needs.ci.outputs.should-deploy == 'true' && needs.ci.outputs.environment == 'dev'
    uses: nuvtools/nuvtools-templates-azure-cicd/.github/workflows/cd-aks.yml@v1
    with:
      environment: dev
      image-uri: ${{ needs.ci.outputs.image-uri }}
      app-version: ${{ needs.ci.outputs.version }}
      aks-cluster-name: my-aks-dev
      aks-resource-group: rg-dev
      namespace: my-app
      release-name: my-app-api
      values-file: helm-values-dev.yml
      env-values-file: env-values-dev.yml
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

  # Deploy to staging (prerelease tags: v*-alpha*, v*-beta*, v*-rc*)
  deploy-staging:
    needs: ci
    if: needs.ci.outputs.should-deploy == 'true' && needs.ci.outputs.environment == 'staging'
    uses: nuvtools/nuvtools-templates-azure-cicd/.github/workflows/cd-aks.yml@v1
    with:
      environment: staging
      image-uri: ${{ needs.ci.outputs.image-uri }}
      app-version: ${{ needs.ci.outputs.version }}
      aks-cluster-name: my-aks-staging
      aks-resource-group: rg-staging
      namespace: my-app
      release-name: my-app-api
      values-file: helm-values-staging.yml
      env-values-file: env-values-staging.yml
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

  # Deploy to production (release tags: v*)
  deploy-production:
    needs: ci
    if: needs.ci.outputs.should-deploy == 'true' && needs.ci.outputs.environment == 'production'
    uses: nuvtools/nuvtools-templates-azure-cicd/.github/workflows/cd-aks.yml@v1
    with:
      environment: production
      image-uri: ${{ needs.ci.outputs.image-uri }}
      app-version: ${{ needs.ci.outputs.version }}
      aks-cluster-name: my-aks-prod
      aks-resource-group: rg-production
      namespace: my-app
      release-name: my-app-api
      values-file: helm-values-production.yml
      env-values-file: env-values-production.yml
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
