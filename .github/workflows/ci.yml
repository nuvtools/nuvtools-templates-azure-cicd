name: CI

on:
  workflow_call:
    inputs:
      dotnet-version:
        description: '.NET SDK version (e.g., 10.0.x).'
        type: string
        required: false
        default: '10.0.x'
      project-path:
        description: 'Path to the solution or project file.'
        type: string
        required: true
      test-path:
        description: 'Path to the test project. Leave empty to skip tests.'
        type: string
        required: false
        default: ''
      configuration:
        description: 'Build configuration.'
        type: string
        required: false
        default: 'Release'
      build-docker:
        description: 'Whether to build and push a Docker image.'
        type: boolean
        required: false
        default: true
      acr-registry:
        description: 'ACR registry name (e.g., myregistry.azurecr.io).'
        type: string
        required: false
        default: ''
      image-name:
        description: 'Docker image name (without registry or tag).'
        type: string
        required: false
        default: ''
      dockerfile:
        description: 'Path to Dockerfile. Leave empty for default .NET Dockerfile.'
        type: string
        required: false
        default: ''
      entry-point-dll:
        description: 'Entry point DLL for default Dockerfile.'
        type: string
        required: false
        default: ''
      publish-artifacts:
        description: 'Whether to publish build artifacts. Enable for artifact-based deployments (zip deploy). Defaults to the value of build-docker.'
        type: boolean
        required: false
        default: true
      environment-override:
        description: 'Override the auto-detected environment name (e.g., dev, uat, staging, production).'
        type: string
        required: false
        default: ''
    secrets:
      AZURE_CLIENT_ID:
        required: false
      AZURE_TENANT_ID:
        required: false
      AZURE_SUBSCRIPTION_ID:
        required: false
      AZURE_CLIENT_SECRET:
        required: false
    outputs:
      version:
        description: 'Resolved version/image tag.'
        value: ${{ jobs.resolve.outputs.version }}
      environment:
        description: 'Resolved target environment.'
        value: ${{ jobs.resolve.outputs.environment }}
      image-uri:
        description: 'Full Docker image URI (empty if docker was skipped).'
        value: ${{ jobs.docker.outputs.image-uri }}
      should-deploy:
        description: 'Whether this build should trigger a deployment.'
        value: ${{ jobs.resolve.outputs.should-deploy }}

permissions:
  contents: read
  id-token: write

jobs:
  resolve:
    name: Resolve Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      environment: ${{ steps.env-resolve.outputs.environment }}
      is-release: ${{ steps.version.outputs.is-release }}
      is-prerelease: ${{ steps.version.outputs.is-prerelease }}
      should-deploy: ${{ steps.version.outputs.should-deploy }}
    steps:
      - name: Resolve version
        id: version
        uses: nuvtools/nuvtools-pipelines/.github/actions/resolve-version@v1
        with:
          run-number: ${{ github.run_number }}

      # Permite sobrescrever o ambiente detectado automaticamente
      - name: Apply environment override
        id: env-resolve
        shell: bash
        run: |
          if [ -n "${{ inputs.environment-override }}" ]; then
            echo "environment=${{ inputs.environment-override }}" >> "$GITHUB_OUTPUT"
          else
            echo "environment=${{ steps.version.outputs.environment }}" >> "$GITHUB_OUTPUT"
          fi

  build-test:
    name: Build & Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build and test
        uses: nuvtools/nuvtools-pipelines/.github/actions/dotnet-build-test@v1
        with:
          dotnet-version: ${{ inputs.dotnet-version }}
          project-path: ${{ inputs.project-path }}
          test-path: ${{ inputs.test-path }}
          configuration: ${{ inputs.configuration }}
          publish-artifacts: ${{ inputs.publish-artifacts }}
          artifact-name: build-output

  docker:
    name: Docker Build & Push
    needs: [resolve, build-test]
    if: inputs.build-docker && needs.resolve.outputs.should-deploy == 'true'
    runs-on: ubuntu-latest
    outputs:
      image-uri: ${{ steps.build-push.outputs.image-uri }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure login
        uses: nuvtools/nuvtools-pipelines/.github/actions/azure-login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          client-secret: ${{ secrets.AZURE_CLIENT_SECRET }}

      - name: Build and push
        id: build-push
        uses: nuvtools/nuvtools-pipelines/.github/actions/docker-build-push@v1
        with:
          registry: ${{ inputs.acr-registry }}
          image-name: ${{ inputs.image-name }}
          image-tag: ${{ needs.resolve.outputs.version }}
          dockerfile: ${{ inputs.dockerfile }}
          artifact-name: build-output
          dotnet-version: ${{ inputs.dotnet-version }}
          entry-point-dll: ${{ inputs.entry-point-dll }}
          push: 'true'
